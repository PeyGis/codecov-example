name: Apply Sonar Scan on PR

on:
  workflow_dispatch:
    inputs:
      prNumber:
        required: true
        type: string
      repository:
        required: true
        type: string
      sonarEntity:
        required: true
        type: string

jobs:
  analyze_sonar:
    runs-on: ubuntu-latest
    env:
      PORT_CLIENT_ID: ${{ secrets.PORT_CLIENT_ID }}
      PORT_CLIENT_SECRET: ${{ secrets.PORT_CLIENT_SECRET }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Port Access Token
        id: get_token
        run: |
          token_response=$(curl -s -X POST https://api.port.io/v1/auth/access_token \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -d "{\"clientId\": \"${PORT_CLIENT_ID}\", \"clientSecret\": \"${PORT_CLIENT_SECRET}\"}")
          
          echo "PORT_TOKEN=$(echo "$token_response" | jq -r .accessToken)" >> "$GITHUB_ENV"

      - name: Get Sonar Entity from Port
        id: get_sonar
        run: |
          sonar_entity_id="${{ github.event.inputs.sonarEntity }}"
          sonar=$(curl -s -X GET "https://api.port.io/v1/blueprints/sonarQubeAnalysis/entities/$sonar_entity_id" \
            -H "Authorization: Bearer $PORT_TOKEN")

          echo "SONAR_ISSUES=$(echo "$sonar" | jq '.entity.properties.newIssues // 0')" >> "$GITHUB_ENV"
          echo "SONAR_COVERAGE=$(echo "$sonar" | jq '.entity.properties.coverage // 0')" >> "$GITHUB_ENV"
          echo "SONAR_DUPLICATIONS=$(echo "$sonar" | jq '.entity.properties.duplications // 0')" >> "$GITHUB_ENV"
          echo "SONAR_BRANCH=$(echo "$sonar" | jq -r '.entity.properties.branch')" >> "$GITHUB_ENV"

      - name: Add PR Label with Sonar Results
        run: |
          pr_number=$(echo "${{ github.event.inputs.prNumber }}" | grep -o '[0-9]\+$')
          label_name="Sonar: $SONAR_ISSUES issues, $SONAR_COVERAGE% coverage"

          # Create label if it doesn't exist
          curl -s -X POST "https://api.github.com/repos/${{ github.repository }}/labels" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"name\": \"$label_name\", \"color\": \"0366d6\"}" || true

          # Apply label to PR
          curl -s -X POST "https://api.github.com/repos/${{ github.repository }}/issues/$pr_number/labels" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"labels\": [\"$label_name\"]}"
