name: Apply Sonar Scan on PR

on:
  workflow_dispatch:
    inputs:
      prNumber:
        required: true
        type: string
      repository:
        required: true
        type: string
      sonarEntity:
        required: true
        type: string

jobs:
  analyze_sonar:
    runs-on: ubuntu-latest
    env:
      PORT_CLIENT_ID: ${{ secrets.PORT_CLIENT_ID }}
      PORT_CLIENT_SECRET: ${{ secrets.PORT_CLIENT_SECRET }}
      GH_TOKEN: ${{ secrets.PERSONAL_GH_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch Port Access Token
        id: fetch_port_token
        run: |
          PORT_ACCESS_TOKEN=$(curl -s -L 'https://api.getport.io/v1/auth/access_token' \
            -H 'Content-Type: application/json' \
            -H 'Accept: application/json' \
            -d '{
              "clientId": "${{ secrets.PORT_CLIENT_ID }}",
              "clientSecret": "${{ secrets.PORT_CLIENT_SECRET }}"
            }' | jq -r '.accessToken')

          echo "PORT_ACCESS_TOKEN=$PORT_ACCESS_TOKEN" >> "$GITHUB_ENV"

      - name: Get Sonar Entity from Port
        id: get_sonar
        run: |
          sonar_entity_id="${{ github.event.inputs.sonarEntity }}"
          echo "üîç Fetching Sonar entity $sonar_entity_id"

          sonar_response=$(curl -s -X GET "https://api.port.io/v1/blueprints/sonarQubeAnalysis/entities/$sonar_entity_id" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ env.PORT_ACCESS_TOKEN }}")

          echo "üì¶ Sonar JSON response:"
          echo "$sonar_response"
          
          SONAR_ISSUES=$(echo "$sonar_response" | jq '.entity.properties.newIssues // 0')
          SONAR_COVERAGE=$(echo "$sonar_response" | jq '.entity.properties.coverage // 0')
          SONAR_DUPLICATIONS=$(echo "$sonar_response" | jq '.entity.properties.duplications // 0')
          SONAR_BRANCH=$(echo "$sonar_response" | jq -r '.entity.properties.branch')
          
          echo "SONAR_ISSUES=$SONAR_ISSUES" >> "$GITHUB_ENV"
          echo "SONAR_COVERAGE=$SONAR_COVERAGE" >> "$GITHUB_ENV"
          echo "SONAR_DUPLICATIONS=$SONAR_DUPLICATIONS" >> "$GITHUB_ENV"
          echo "SONAR_BRANCH=$SONAR_BRANCH" >> "$GITHUB_ENV"

      - name: Add PR Label with Sonar Results
        run: |
          pr_number=$(echo "${{ github.event.inputs.prNumber }}" | grep -o '[0-9]\+$')
          label_name="Sonar: $SONAR_ISSUES issues, $SONAR_COVERAGE% coverage"

          echo "üè∑Ô∏è Creating label: $label_name"

          label_response=$(curl -i -X POST "https://api.github.com/repos/${{ github.event.inputs.repository }}/labels" \
            -H "Authorization: Bearer ${{ secrets.PERSONAL_GH_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"name\": \"$label_name\", \"color\": \"0366d6\"}")

          echo "üì¶ Label creation response: "
          echo "$label_response"

          echo "üè∑Ô∏è Applying label to PR $pr_number..."

          apply_response=$(curl -i -s -w "\n%{http_code}" -X POST "https://api.github.com/repos/${{ github.event.inputs.repository }}/issues/$pr_number/labels" \
            -H "Authorization: Bearer ${{ secrets.PERSONAL_GH_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"labels\": [\"$label_name\"]}")

          apply_body=$(echo "$apply_response" | sed '$d')
          apply_status=$(echo "$apply_response" | tail -n1)

          echo "üì¶ Apply label response ($apply_status):"
          echo "$apply_body"

          if [ "$apply_status" -ne 200 ]; then
            echo "‚ùå Failed to apply label to PR"
            exit 1
          fi
